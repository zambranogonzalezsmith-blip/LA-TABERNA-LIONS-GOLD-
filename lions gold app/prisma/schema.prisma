// Configuración de la base de datos
datasource db {
  provider = "postgresql" // Puedes usar MySQL o SQLite si prefieres
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 1. MODELO DE USUARIO (Jugadores)
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  emailVerified     Boolean  @default(false)
  albionUsername    String   @unique // El nombre del personaje in-game
  passwordHash      String
  
  // Sistema de Puntuación (Estilo Bybit)
  reputationScore   Float    @default(5.0) // Inicia con 5 estrellas
  totalTrades       Int      @default(0)
  positiveReviews   Int      @default(0)
  
  // Seguridad y Anti-Scam
  isBanned          Boolean  @default(false)
  scamReportsCount  Int      @default(0)
  
  // Relaciones
  tradesAsBuyer     Trade[]  @relation("Buyer")
  tradesAsSeller    Trade[]  @relation("Seller")
  reportsMade       Report[] @relation("Reporter")
  reportsReceived   Report[] @relation("Reported")
  reviewsReceived   Review[] @relation("Reviewee")

  createdAt         DateTime @default(now())
}

// 2. MODELO DE TRANSACCIONES (El corazón de La Taberna)
model Trade {
  id              String   @id @default(uuid())
  status          TradeStatus @default(PENDING)
  
  // Participantes
  buyerId         String
  buyer           User     @relation("Buyer", fields: [buyerId], references: [id])
  sellerId        String
  seller          User     @relation("Seller", fields: [sellerId], references: [id])

  // Detalles del Item/Dinero
  itemCategory    String   // Armas, Monturas, Materiales, etc.
  amount          Float    // Cantidad total (Silver, Gold o USDT)
  currency        Currency @default(SILVER)
  
  // COMISIÓN LIONS-GOLD (0.06%)
  fee             Float    // Aquí guardas el monto del 0.06%
  finalAmount     Float    // Lo que recibe el vendedor tras la comisión

  // Anti-Ban
  silverLimitAlert Boolean @default(false) // Se activa si supera el límite de riesgo

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  Review          Review?
}

// 3. MODELO DE REVIEWS (Puntuación y Comentarios)
model Review {
  id          String   @id @default(uuid())
  tradeId     String   @unique
  trade       Trade    @relation(fields: [tradeId], references: [id])
  
  rating      Int      // Del 1 al 5
  comment     String?  // Opcional
  
  revieweeId  String
  reviewee    User     @relation("Reviewee", fields: [revieweeId], references: [id])
}

// 4. MODELO DE REPORTES (Anti-Estafas)
model Report {
  id              String   @id @default(uuid())
  reporterId      String
  reporter        User     @relation("Reporter", fields: [reporterId], references: [id])
  
  reportedUserId  String
  reportedUser    User     @relation("Reported", fields: [reportedUserId], references: [id])
  
  reason          String
  evidenceLink    String   // Link a captura de pantalla (Imgur, Discord, etc.)
  status          ReportStatus @default(OPEN)
  
  createdAt       DateTime @default(now())
}

// ENUMS (Opciones fijas)
enum TradeStatus {
  PENDING
  IN_ESCROW
  COMPLETED
  CANCELLED
  DISPUTED
}

enum Currency {
  SILVER
  GOLD
  USDT
}

enum ReportStatus {
  OPEN
  RESOLVED
  DISMISSED
}
